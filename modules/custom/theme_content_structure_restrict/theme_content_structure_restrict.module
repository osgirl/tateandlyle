<?php

/**
 * @file
 * Allow configuring and hiding fields from node forms via theme configuration.
 */

use Drupal\Core\Access\AccessResultForbidden;
use Drupal\Core\Access\AccessResultNeutral;
use Drupal\Core\Field\FieldDefinitionInterface;
use Drupal\Core\Field\FieldItemListInterface;
use Drupal\Core\Session\AccountInterface;

/*
 * Implements hook_entity_field_access();
 */
function theme_content_structure_restrict_entity_field_access($operation, FieldDefinitionInterface $field_definition, AccountInterface $account, FieldItemListInterface $items = NULL) {

  $config = \Drupal::config('system.theme');
  $default_theme = $config->get('default');

  // get fields to restrict
  $fields_to_restrict = theme_get_setting('theme_content_structure_restrict_fields', $default_theme);

  // no fields
  if (empty($fields_to_restrict)) {
    $fields_to_restrict = array();
  }

  $field_name = $field_definition->getName();

  if (in_array($operation, array('edit', 'created')) && in_array($field_name, $fields_to_restrict)) {
    return new AccessResultForbidden();
  }

  return new AccessResultNeutral();
}

/*
 * Implements hook_ENTITYTPE_node_create_access().
 */
function theme_content_structure_restrict_node_create_access($account, array $context, $entity_bundle)  {

  $config = \Drupal::config('system.theme');
  $default_theme = $config->get('default');

  // get fields to restrict
  $cts_to_restrict = theme_get_setting('theme_content_structure_restrict_cts', $default_theme);

  // no fields
  if (empty($cts_to_restrict)) {
    $cts_to_restrict = array();
  }

  if (in_array($entity_bundle, $cts_to_restrict)) {
    return new AccessResultForbidden();
  }

  return new AccessResultNeutral();
}
